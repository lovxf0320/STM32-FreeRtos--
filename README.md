# STM32与FreeRTOS项目

## 项目概述

这是一个基于STM32F103ZE微控制器和FreeRTOS实时操作系统的嵌入式项目。项目实现了多任务系统，包含传感器读取、电机控制、通信等功能。

## 硬件平台

- **微控制器**: STM32F103ZE (ARM Cortex-M3内核)
- **时钟频率**: 72MHz
- **Flash容量**: 512KB
- **RAM容量**: 64KB
- **封装**: LQFP144

## 主要功能模块

### 1. 系统管理
- **FreeRTOS**: 实时操作系统，提供任务调度、内存管理、同步机制等
- **系统时钟**: 配置系统时钟和外设时钟
- **中断管理**: 配置和管理各种中断源

### 2. 传感器模块
- **MPU6050**: 6轴陀螺仪加速度计，用于姿态检测
- **编码器**: 电机转速和位置反馈
- **按键**: 用户输入接口
- **LED**: 状态指示

### 3. 执行器控制
- **直流电机**: PWM控制，支持正反转和调速
- **步进电机**: 精确位置控制
- **PWM输出**: 可调节占空比的脉冲信号

### 4. 通信接口
- **USART1**: 主串口，用于调试和通信
- **USART2**: 连接ESP8266 WiFi模块
- **I2C**: 连接MPU6050等I2C设备
- **SPI**: 高速数据传输接口

### 5. 显示和交互
- **LCD**: 图形显示界面
- **触摸屏**: 人机交互输入

## 项目结构

```
STM32与FreeRtos项目/
├── CORE/                    # ARM Cortex-M3核心文件
│   ├── core_cm3.c         # CMSIS核心功能
│   ├── core_cm3.h         # CMSIS核心头文件
│   └── startup_stm32f10x_hd.s  # 启动文件
├── FreeRTOS/               # FreeRTOS实时操作系统
│   ├── include/            # FreeRTOS头文件
│   ├── portable/           # 移植层文件
│   ├── tasks.c             # 任务管理
│   ├── queue.c             # 队列管理
│   ├── semphr.c            # 信号量管理
│   └── timers.c            # 软件定时器
└── USER/                   # 用户代码
    ├── main.c              # 主程序
    ├── stm32f10x_it.c     # 中断服务程序
    ├── stm32f10x_it.h     # 中断服务程序头文件
    ├── stm32f10x_conf.h   # 库配置文件
    └── Objects/            # 编译输出文件
```

## 开发环境

- **IDE**: Keil uVision5
- **编译器**: ARM Compiler V5
- **调试器**: ST-Link V2
- **操作系统**: Windows 10

## 编译和下载

### 1. 编译项目
1. 打开Keil uVision5
2. 加载项目文件 `FreeRTOS.uvprojx`
3. 选择目标设备 (STM32F103ZE)
4. 点击编译按钮或按F7

### 2. 下载程序
1. 连接ST-Link调试器
2. 点击下载按钮或按F8
3. 等待下载完成

## 任务设计

### 主要任务
1. **系统监控任务**: 监控系统状态，处理异常
2. **传感器读取任务**: 读取MPU6050、编码器等传感器数据
3. **电机控制任务**: 控制直流电机和步进电机
4. **通信任务**: 处理串口和WiFi通信
5. **显示任务**: 更新LCD显示内容
6. **按键处理任务**: 响应用户按键输入

### 任务优先级
- 系统监控: 最高优先级
- 传感器读取: 高优先级
- 电机控制: 中优先级
- 通信处理: 中优先级
- 显示更新: 低优先级
- 按键处理: 低优先级

## 中断配置

### 系统中断
- **SysTick**: 系统滴答定时器，为FreeRTOS提供时间基准
- **PendSV**: FreeRTOS上下文切换中断

### 外设中断
- **USART**: 串口接收中断
- **Timer**: 定时器中断
- **EXTI**: 外部中断（按键、编码器等）

## 配置说明

### FreeRTOS配置
- **configTICK_RATE_HZ**: 1000Hz (1ms滴答)
- **configMAX_PRIORITIES**: 32个优先级
- **configUSE_PREEMPTION**: 启用抢占式调度
- **configUSE_IDLE_HOOK**: 启用空闲钩子函数

### 系统时钟配置
- **系统时钟**: 72MHz
- **AHB总线**: 72MHz
- **APB1总线**: 36MHz
- **APB2总线**: 72MHz

## 注意事项

1. **中断处理**: 中断服务程序应尽量简短，避免长时间占用CPU
2. **任务设计**: 合理分配任务优先级，避免优先级反转
3. **内存管理**: 使用FreeRTOS提供的内存管理函数，避免内存泄漏
4. **实时性**: 关键任务应设置合适的优先级，确保实时性要求

## 故障排除

### 常见问题
1. **编译错误**: 检查头文件路径和库文件版本
2. **下载失败**: 检查ST-Link连接和驱动安装
3. **程序运行异常**: 检查中断配置和任务优先级设置
4. **通信问题**: 检查波特率、数据位、停止位等串口参数

### 调试技巧
1. 使用LED指示系统状态
2. 通过串口输出调试信息
3. 使用Keil的调试功能设置断点
4. 检查FreeRTOS任务状态和堆栈使用情况

## 版本历史

- **V1.0.0**: 初始版本，基本功能实现
- 支持基本的传感器读取和电机控制
- 集成FreeRTOS实时操作系统
- 实现多任务调度

## 联系方式

如有问题或建议，请联系开发团队。

---

**注意**: 本程序仅供学习和研究使用，请勿用于商业用途。
